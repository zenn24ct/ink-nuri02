<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chroma Snap</title>
  <style>
    :root {
      --bg-dark: #0f172a;
      --panel-bg: rgba(30, 41, 59, 0.7);
      --accent-color: #38bdf8;
      --text-main: #f8fafc;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--bg-dark);
      background-image: 
        radial-gradient(circle at 2px 2px, rgba(255,255,255,0.05) 1px, transparent 0);
      background-size: 40px 40px;
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      color: var(--text-main);
      overflow: hidden;
    }

    /* メインレイアウト */
    .game-viewport {
      display: flex;
      flex-direction: row;
      gap: 30px;
      width: min(1100px, 95vw);
      height: min(700px, 90vh);
    }

    /* 左：ゲームボードエリア */
    .board-section {
      flex: 1;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .progress-container {
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      overflow: hidden;
    }
    #progressBar {
      width: 0%;
      height: 100%;
      background: var(--accent-color);
      box-shadow: 0 0 10px var(--accent-color);
      transition: width 0.3s ease;
    }

    .grid {
      flex: 1;
      display: grid;
      gap: 4px;
      background: var(--panel-bg);
      padding: 10px;
      border-radius: 16px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      cursor: crosshair;
    }

    .cell {
      background: rgba(255,255,255,0.03);
      border-radius: 4px;
      transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
    }
    .cell.correct { transform: scale(0.9); }
    .cell.wrong { animation: shake 0.4s; }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      75% { transform: translateX(4px); }
    }

    /* 右：コントロールパネル */
    .side-panel {
      width: 280px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .stats-card {
      background: var(--panel-bg);
      padding: 20px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .stat-label { font-size: 0.8rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }
    .stat-value { font-size: 1.8rem; font-weight: 800; margin-bottom: 10px; }

    .palette-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 10px;
    }

    .swatch {
      aspect-ratio: 1;
      border-radius: 8px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: transform 0.2s;
    }
    .swatch:hover { transform: scale(1.1); }
    .swatch.active { border-color: #fff; transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.4); }

    .btn {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 1rem;
    }
    .btn-primary { background: var(--accent-color); color: #000; }
    .btn-primary:hover { background: #7dd3fc; transform: translateY(-2px); }
    .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; margin-top: 10px;}

    /* 演出用 */
    .combo-popup {
      position: absolute;
      pointer-events: none;
      color: var(--accent-color);
      font-weight: 900;
      font-size: 2rem;
      animation: floatUp 0.8s ease-out forwards;
      z-index: 100;
    }

    @keyframes floatUp {
      0% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-50px); }
    }
  </style>
</head>
<body>

  <div class="game-viewport">
    <div class="board-section">
      <div style="display: flex; justify-content: space-between; align-items: flex-end;">
        <h1 style="font-size: 1.5rem;">CHROMA SNAP</h1>
        <div id="timerDisplay" style="font-family: monospace; font-size: 1.5rem; color: var(--accent-color);">01:00</div>
      </div>
      
      <div class="progress-container">
        <div id="progressBar"></div>
      </div>

      <div class="grid" id="grid"></div>
    </div>

    <div class="side-panel">
      <div class="stats-card">
        <div class="stat-label">Score</div>
        <div id="score" class="stat-value">0</div>
        
        <div class="stat-label">Combo</div>
        <div id="combo" class="stat-value" style="color: #fbbf24;">x1</div>
      </div>

      <div class="stats-card">
        <div class="stat-label">Brush Color</div>
        <div class="palette-grid" id="palette"></div>
      </div>

      <button id="startBtn" class="btn btn-primary">START GAME</button>
      <button id="hintBtn" class="btn btn-secondary">Toggle Hints</button>
      
      <p style="font-size: 0.75rem; color: #64748b; line-height: 1.4;">
        [遊び方] パレットから色を選び、グリッド内の薄いヒントと同じ色でクリック（ドラッグ）して塗りつぶしてください。
      </p>
    </div>
  </div>

<script>
  const CONFIG = {
    gridSize: 8,
    gameDuration: 60,
    colors: [
      '#ef4444', '#f97316', '#f59e0b', '#10b981', 
      '#3b82f6', '#6366f1', '#8b5cf6', '#ec4899'
    ]
  };

  let state = {
    score: 0,
    combo: 0,
    timeLeft: CONFIG.gameDuration,
    isRunning: false,
    selectedColor: CONFIG.colors[0],
    targetsFilled: 0,
    totalTargets: CONFIG.gridSize ** 2,
    lastCorrectTime: 0,
    hintsVisible: true
  };

  const gridEl = document.getElementById('grid');
  const paletteEl = document.getElementById('palette');
  const scoreEl = document.getElementById('score');
  const comboEl = document.getElementById('combo');
  const timerEl = document.getElementById('timerDisplay');
  const progressBar = document.getElementById('progressBar');
  const startBtn = document.getElementById('startBtn');

  // --- 初期化 ---
  function init() {
    // グリッド生成
    gridEl.style.gridTemplateColumns = `repeat(${CONFIG.gridSize}, 1fr)`;
    createGrid();
    
    // パレット生成
    CONFIG.colors.forEach(color => {
      const sw = document.createElement('div');
      sw.className = 'swatch';
      sw.style.backgroundColor = color;
      if(color === state.selectedColor) sw.classList.add('active');
      sw.onclick = () => {
        state.selectedColor = color;
        document.querySelectorAll('.swatch').forEach(s => s.classList.remove('active'));
        sw.classList.add('active');
      };
      paletteEl.appendChild(sw);
    });

    // イベント
    startBtn.onclick = toggleGame;
    document.getElementById('hintBtn').onclick = toggleHints;
    
    let isDragging = false;
    gridEl.onmousedown = () => isDragging = true;
    window.onmouseup = () => isDragging = false;
  }

  function createGrid() {
    gridEl.innerHTML = '';
    state.targetsFilled = 0;
    for (let i = 0; i < state.totalTargets; i++) {
      const cell = document.createElement('div');
      const targetColor = CONFIG.colors[Math.floor(Math.random() * CONFIG.colors.length)];
      cell.className = 'cell';
      cell.dataset.target = targetColor;
      cell.dataset.filled = "false";
      
      // ヒント表示用の内側要素
      const hint = document.createElement('div');
      hint.className = 'hint-layer';
      hint.style.cssText = `position:absolute; inset:8px; border-radius:4px; background:${targetColor}; opacity:0.15; transition:0.3s;`;
      cell.appendChild(hint);

      const handleAction = () => {
        if (!state.isRunning || cell.dataset.filled === "true") return;
        processMove(cell, hint);
      };

      cell.onmousedown = handleAction;
      cell.onmouseenter = (e) => { if(e.buttons === 1) handleAction(); };
      
      gridEl.appendChild(cell);
    }
  }

  function processMove(cell, hint) {
    const isCorrect = state.selectedColor === cell.dataset.target;

    if (isCorrect) {
      cell.dataset.filled = "true";
      cell.style.backgroundColor = state.selectedColor;
      cell.classList.add('correct');
      hint.style.opacity = '0';
      
      // コンボ計算 (1.5秒以内)
      const now = Date.now();
      if (now - state.lastCorrectTime < 1500) {
        state.combo++;
      } else {
        state.combo = 1;
      }
      state.lastCorrectTime = now;
      
      state.score += 10 * state.combo;
      state.targetsFilled++;
      
      // 演出
      if(state.combo > 5) spawnComboText(cell);
      
    } else {
      state.combo = 0;
      state.timeLeft = Math.max(0, state.timeLeft - 2);
      cell.classList.add('wrong');
      setTimeout(() => cell.classList.remove('wrong'), 400);
    }
    
    updateUI();
    checkWin();
  }

  function updateUI() {
    scoreEl.innerText = state.score.toLocaleString();
    comboEl.innerText = `x${state.combo}`;
    comboEl.style.transform = `scale(${1 + Math.min(state.combo/10, 0.5)})`;
    
    const progress = (state.targetsFilled / state.totalTargets) * 100;
    progressBar.style.width = `${progress}%`;

    const m = Math.floor(state.timeLeft / 60);
    const s = state.timeLeft % 60;
    timerEl.innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
  }

  function spawnComboText(el) {
    const rect = el.getBoundingClientRect();
    const popup = document.createElement('div');
    popup.className = 'combo-popup';
    popup.innerText = `${state.combo} COMBO!`;
    popup.style.left = `${rect.left}px`;
    popup.style.top = `${rect.top}px`;
    document.body.appendChild(popup);
    setTimeout(() => popup.remove(), 800);
  }

  function toggleGame() {
    if (state.isRunning) return;
    
    // リセット
    state.score = 0;
    state.combo = 0;
    state.timeLeft = CONFIG.gameDuration;
    state.isRunning = true;
    createGrid();
    startBtn.innerText = "GAME RUNNING";
    startBtn.disabled = true;

    const timer = setInterval(() => {
      state.timeLeft--;
      updateUI();
      if (state.timeLeft <= 0 || !state.isRunning) {
        clearInterval(timer);
        endGame();
      }
    }, 1000);
  }

  function endGame() {
    state.isRunning = false;
    startBtn.innerText = "RESTART GAME";
    startBtn.disabled = false;
    alert(`GAME OVER\nScore: ${state.score}\nFilled: ${state.targetsFilled}/${state.totalTargets}`);
  }

  function checkWin() {
    if (state.targetsFilled === state.totalTargets) {
      state.score += state.timeLeft * 50; // 残り時間ボーナス
      state.isRunning = false;
      updateUI();
      setTimeout(() => alert("PERFECT CLEAR!"), 100);
    }
  }

  function toggleHints() {
    state.hintsVisible = !state.hintsVisible;
    document.querySelectorAll('.hint-layer').forEach(h => {
      h.style.display = state.hintsVisible ? 'block' : 'none';
    });
  }

  init();
</script>
</body>
</html>